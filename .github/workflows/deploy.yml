name: ğŸš€ CD - Deploy

on:
  push:
    branches: [main, develop, new-structure]
  workflow_run:
    workflows: ["ğŸ” CI - Quality Assurance"]
    types: [completed]
    branches: [main, develop, new-structure]

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  deploy-preview:
    name: ğŸ” Deploy Preview (Homolog)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      github.ref == 'refs/heads/develop' || 
      (github.event.workflow_run.conclusion == 'success' && 
       github.event.workflow_run.head_branch == 'develop')

    environment:
      name: preview
      url: ${{ steps.deploy.outputs.preview-url }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "pnpm"

      - name: ğŸ“¥ Install Vercel CLI
        run: npm install --global vercel@latest

      - name: ğŸ”— Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: ğŸ—ï¸ Build Project Artifacts
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: ğŸš€ Deploy to Vercel (Preview)
        id: deploy
        run: |
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "preview-url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "ğŸ”— Preview deployed to: $DEPLOYMENT_URL"

      - name: ğŸ’¬ Comment PR with preview link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ” Preview Deployment
              
              âœ… **Deploy Status**: Success
              ğŸ”— **Preview URL**: ${{ steps.deploy.outputs.preview-url }}
              ğŸ“ **Commit**: ${context.sha.substring(0, 7)}
              ğŸŒ¿ **Branch**: ${context.ref.replace('refs/heads/', '')}
              
              ### ğŸ§ª Test your changes:
              - [ ] NavegaÃ§Ã£o geral
              - [ ] Funcionalidades de comunicaÃ§Ãµes
              - [ ] Responsividade mobile
              - [ ] Performance (Core Web Vitals)
              
              *Deployment powered by [Vercel](https://vercel.com)*`
            })

  deploy-production:
    name: ğŸŒŸ Deploy Production
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: |
      github.ref == 'refs/heads/main' || 
      (github.event.workflow_run.conclusion == 'success' && 
       github.event.workflow_run.head_branch == 'main')

    environment:
      name: production
      url: https://your-production-domain.vercel.app

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "pnpm"

      - name: ğŸ“¥ Install Vercel CLI
        run: npm install --global vercel@latest

      - name: ğŸ”— Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: ğŸ—ï¸ Build Project Artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: ğŸš€ Deploy to Vercel (Production)
        id: deploy
        run: |
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "production-url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "ğŸŒŸ Production deployed to: $DEPLOYMENT_URL"

      - name: ğŸ‰ Create release
        if: github.ref == 'refs/heads/main'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release v${{ github.run_number }}
          body: |
            ## ğŸš€ Release v${{ github.run_number }}

            **ğŸŒŸ Production URL**: ${{ steps.deploy.outputs.production-url }}
            **ğŸ“ Commit**: ${{ github.sha }}
            **ğŸ• Deployed at**: ${{ github.event.head_commit.timestamp }}

            ### âœ¨ What's included:
            - Performance optimizations
            - Bug fixes and improvements
            - Latest features and enhancements

            ### ğŸ” Verification checklist:
            - [x] All tests passing
            - [x] Build successful
            - [x] Security audit passed
            - [x] Lighthouse performance â‰¥ 90

            *Automated deployment via GitHub Actions*
          draft: false
          prerelease: false

  rollback:
    name: ğŸ”„ Rollback (if needed)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: failure() && github.ref == 'refs/heads/main'
    needs: [deploy-production]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Install Vercel CLI
        run: npm install --global vercel@latest

      - name: ğŸ”„ Rollback deployment
        run: |
          echo "ğŸ”„ Rolling back to previous deployment..."
          # Get previous deployment and promote it
          PREV_DEPLOYMENT=$(vercel ls --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_ORG_ID }} | head -2 | tail -1 | awk '{print $1}')
          vercel promote $PREV_DEPLOYMENT --token=${{ secrets.VERCEL_TOKEN }}
          echo "âœ… Rollback completed to deployment: $PREV_DEPLOYMENT"

      - name: ğŸš¨ Notify team
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Production Deployment Failed - Rollback Initiated',
              body: `## ğŸš¨ Production Deployment Failure
              
              **ğŸ”„ Status**: Rollback initiated
              **ğŸ“ Failed Commit**: ${context.sha}
              **ğŸ• Time**: ${new Date().toISOString()}
              
              ### ğŸ” Next Steps:
              1. Review the failed deployment logs
              2. Fix the issues in a new PR
              3. Test thoroughly before merging to main
              
              **ğŸ”— Workflow Run**: [View Details](${context.payload.repository.html_url}/actions/runs/${context.runId})`,
              labels: ['bug', 'urgent', 'deployment']
            })
