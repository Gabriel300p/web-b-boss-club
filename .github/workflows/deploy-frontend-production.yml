name: ðŸš€ Deploy Frontend to AWS S3 + CloudFront

on:
  push:
    branches:
      - main
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".github/**"
      - "!.github/workflows/**"

  workflow_dispatch:
    inputs:
      reason:
        description: "Reason for manual deployment"
        required: false
        default: "Manual deployment"

env:
  AWS_REGION: us-east-1
  S3_BUCKET: bboss-web-prod
  NODE_VERSION: "18"

jobs:
  deploy:
    name: Build and Deploy Frontend
    runs-on: ubuntu-latest

    steps:
      # ========================================
      # CHECKOUT CODE
      # ========================================
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # ========================================
      # SETUP NODE.JS
      # ========================================
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # ========================================
      # SETUP PNPM
      # ========================================
      - name: ðŸ“¦ Setup PNPM
        uses: pnpm/action-setup@v3
        with:
          version: 9.0.0

      # ========================================
      # CACHE DEPENDENCIES
      # ========================================
      - name: ðŸ’¾ Cache PNPM dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      # ========================================
      # INSTALL DEPENDENCIES
      # ========================================
      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      # ========================================
      # BUILD APPLICATION
      # ========================================
      - name: ðŸ—ï¸ Build application
        run: pnpm run build
        env:
          # Inject environment variables for Vite build
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      # ========================================
      # CONFIGURE AWS CREDENTIALS
      # ========================================
      - name: ðŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ========================================
      # DEPLOY TO S3
      # ========================================
      - name: ðŸš€ Deploy to S3
        run: |
          # Sync all files except HTML files with long cache
          aws s3 sync dist/ s3://${{ env.S3_BUCKET }}/ \
            --delete \
            --cache-control "public, max-age=31536000" \
            --exclude "*.html" \
            --exclude "manifest.webmanifest"

          # Upload HTML files with correct charset
          find dist/ -type f -name "*.html" -exec sh -c 'aws s3 cp "$0" "s3://${{ env.S3_BUCKET }}/${0#dist/}" --cache-control "no-cache, no-store, must-revalidate" --content-type "text/html; charset=utf-8"' {} \;

          # Upload manifest with correct content-type
          if [ -f "dist/manifest.webmanifest" ]; then
            aws s3 cp dist/manifest.webmanifest s3://${{ env.S3_BUCKET }}/manifest.webmanifest \
              --cache-control "public, max-age=31536000" \
              --content-type "application/manifest+json; charset=utf-8"
          fi

      # ========================================
      # INVALIDATE CLOUDFRONT CACHE
      # ========================================
      - name: ðŸ”„ Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

      # ========================================
      # GET CLOUDFRONT DOMAIN
      # ========================================
      - name: ðŸ“‹ Get CloudFront domain
        id: cloudfront
        run: |
          DOMAIN=$(aws cloudfront get-distribution \
            --id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --query 'Distribution.DomainName' \
            --output text)
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT
          echo "url=https://$DOMAIN" >> $GITHUB_OUTPUT

      # ========================================
      # DEPLOYMENT SUMMARY
      # ========================================
      - name: âœ… Deployment Summary
        run: |
          echo "### ðŸš€ Frontend Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ CloudFront URL: [${{ steps.cloudfront.outputs.url }}](${{ steps.cloudfront.outputs.url }})" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ S3 Bucket: \`${{ env.S3_BUCKET }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ Region: \`${{ env.AWS_REGION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ‘¤ Author: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. â³ Wait 1-5 minutes for CloudFront cache invalidation" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ”— Access site: [${{ steps.cloudfront.outputs.url }}](${{ steps.cloudfront.outputs.url }})" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… Verify backend API integration" >> $GITHUB_STEP_SUMMARY
